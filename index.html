<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enquiry Log 2026 - Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/table-to-excel"></script>
</head>
<body class="bg-gray-100 p-8">
  <div id="app" class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold mb-8">Enquiry / Estimation Log</h1>
    
    <!-- Filters -->
    <div class="bg-white p-6 rounded-lg shadow mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
        <select v-model="filters.month" class="border p-2 rounded">
          <option value="">All Months</option>
          <option v-for="m in months" :key="m" :value="m">{{ m }}</option>
        </select>
        <input v-model="filters.manager" placeholder="Project Manager" class="border p-2 rounded">
        <input v-model="filters.search" @input="filterData" placeholder="Search..." class="border p-2 rounded md:col-span-2">
      </div>
      <div class="flex gap-2">
        <button @click="addMain" class="bg-blue-500 text-white px-4 py-2 rounded flex items-center gap-1">
          ➕ Add Main Quote
        </button>
        <button @click="exportExcel" class="bg-green-500 text-white px-4 py-2 rounded">
          ⬇ Download Excel
        </button>
      </div>
    </div>

    <!-- Totals (Admin only) -->
    <div v-if="isAdmin" class="bg-green-50 p-4 rounded mb-6">
      <div class="flex justify-between">
        <span>Total Value ({{ currency }}): </span>
        <strong>{{ formatCurrency(totals.total) }}</strong>
      </div>
    </div>

    <!-- Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <table class="w-full table-auto">
        <thead class="bg-gray-200 sticky top-0 z-10">
          <tr>
            <th class="p-3 font-semibold sticky left-0 bg-gray-200 z-20">Month</th>
            <th class="p-3 font-semibold sticky left-1 bg-gray-200 z-20">Sl.No</th>
            <th class="p-3 font-semibold sticky left-2 bg-gray-200 z-20">Type</th>
            <th class="p-3 font-semibold sticky left-3 bg-gray-200 z-20">Quote No</th>
            <th class="p-3 font-semibold">Project</th>
            <th class="p-3 font-semibold">Manager</th>
            <th class="p-3 font-semibold">Candidate</th>
            <th class="p-3 font-semibold">Enquiry Date</th>
            <th class="p-3 font-semibold">Deadline</th>
            <th class="p-3 font-semibold">Status</th>
            <th v-if="isAdmin" class="p-3 font-semibold">Value</th>
            <th class="p-3 font-semibold">Action</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(row, index) in filteredData" :key="index" class="border-t hover:bg-gray-50">
            <td class="p-3 sticky left-0 bg-white">{{ row[0] }}</td>
            <td class="p-3 sticky left-1 bg-white">{{ row[1] }}</td>
            <td class="p-3 sticky left-2 bg-white">{{ row[2] }}</td>
            <td class="p-3 sticky left-3 bg-white font-mono">{{ row[3] }}</td>
            <td class="p-3 max-w-md" style="height: auto; min-height: 40px;">{{ row[4] }}</td>
            <td class="p-3">{{ row[5] }}</td>
            <td class="p-3">{{ row[6] }}</td>
            <td class="p-3">{{ row[7] }}</td>
            <td class="p-3">{{ row[8] }}</td>
            <td class="p-3">
              <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">{{ row[9] }}</span>
            </td>
            <td v-if="isAdmin" class="p-3 font-mono">{{ formatCurrency(row[10]) }}</td>
            <td class="p-3">
              <button @click="deleteRow(index)" class="text-red-500 hover:text-red-700 text-sm mr-2">❌</button>
              <button @click="editRow(index)" class="text-blue-500 hover:text-blue-700 text-sm">✏️</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const { createApp } = Vue;
    createApp({
      data() {
        return {
          data: [], // Load sample data or from API
          filteredData: [],
          filters: { month: '', manager: '', search: '' },
          months: ['JAN 2026', 'FEB 2026'], // Dynamic up to +10 years
          currency: 'AED',
          isAdmin: true, // Detect via google.script.run.getUserRole()
          totals: { total: 0 }
        };
      },
      mounted() {
        this.loadData();
      },
      methods: {
        loadData() {
          // Demo data (replace with google.script.run.getData(filters))
          this.data = [
            ['JAN 2026', 1, 'Main', '8669', 'Project Alpha Multi-line desc...', 'Praneeth', 'Candidate A', '01/01/26', '15/01/26', 'Pending', 50000],
            ['JAN 2026', 1, 'Additional', '8669-A1', 'Project Alpha Multi-line desc...', 'Praneeth', 'Candidate A', '02/01/26', '16/01/26', 'Approved', 10000]
          ];
          this.filteredData = this.data;
          this.updateTotals();
        },
        filterData() {
          this.filteredData = this.data.filter(row => 
            (!this.filters.month || row[0] === this.filters.month) &&
            (!this.filters.manager || row[5].includes(this.filters.manager)) &&
            (!this.filters.search || JSON.stringify(row).toLowerCase().includes(this.filters.search.toLowerCase()))
          );
          this.updateTotals();
        },
        addMain() {
          // google.script.run.addMainQuote(data)
          alert('Saves to Sheet1 via Apps Script (Admin only)');
        },
        deleteRow(index) { /* google.script.run.deleteRow */ },
        editRow(index) { /* Edit mode */ },
        updateTotals() {
          // Admin only, sum filtered Value col, convert currency
          this.totals.total = this.filteredData.reduce((sum, row) => sum + (row[10] || 0), 0);
        },
        formatCurrency(val) {
          return new Intl.NumberFormat('en-AE', { style: 'currency', currency: this.currency }).format(val);
        },
        exportExcel() {
          const table = document.querySelector('table');
          table.toExcel('enquiry-log.xlsx');
        }
      },
      watch: {
        filters: { handler: 'filterData', deep: true }
      }
    }).mount('#app');
  </script>
</body>
</html>
