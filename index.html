<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body{
      font-family:Calibri,Arial,sans-serif;
      font-size:13px;
      background:#f4f6f8;
      padding:10px
    }
    h2{margin:0}
    .top{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:8px
    }
    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      margin-top:8px
    }
    th,td{
      border:1px solid #ccc;
      padding:5px;
      text-align:center
    }
    th{background:#e9eef5}
    input,select,textarea{
      font-size:12px;
      width:100%;
      box-sizing:border-box
    }
    textarea{
      resize:none;
      min-height:22px
    }
    button{
      background:#0b2c5d;
      color:#fff;
      border:none;
      padding:5px 10px;
      cursor:pointer
    }
    .hidden{display:none}
    .del{color:#c0392b;cursor:pointer;font-weight:bold}
    .total{
      margin-top:8px;
      text-align:right;
      font-weight:bold
    }
  </style>
</head>

<body>

<h2>Enquiry Log</h2>
<div>IRS-FORM-13-01</div>

<div class="top">
  <select id="month"></select>
  <select id="managerFilter">
    <option value="">All Managers</option>
  </select>
  <button onclick="addMain()">➕ Add Main Quote</button>
  <button id="exportBtn" onclick="exportExcel()">⬇️ Download Excel</button>
</div>

<table>
<thead>
<tr>
  <th>Month</th>
  <th>Sl.No</th>
  <th>Type</th>
  <th>Quote</th>
  <th>Project</th>
  <th>Manager</th>
  <th>Candidate</th>
  <th>Enquiry</th>
  <th>Deadline</th>
  <th>Status</th>
  <th id="valHead">Value</th>
  <th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<div id="totalBox" class="total"></div>

<script>
/* ---------- SETUP ---------- */
const months=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
const managers=["Mr. Vishal","Mr. Mukesh","Mr. Irshad","Mr. Prem","Ms. Tania","Mr. Robbin"];

const monthSel=document.getElementById("month");
const managerFilter=document.getElementById("managerFilter");
const tbody=document.getElementById("tbody");
const totalBox=document.getElementById("totalBox");
const valHead=document.getElementById("valHead");
const exportBtn=document.getElementById("exportBtn");

months.forEach(m=>monthSel.add(new Option(m,m)));
monthSel.value=months[new Date().getMonth()];
managers.forEach(m=>managerFilter.add(new Option(m,m)));

let ROLE="EDITOR";
let ALL_ROWS=[];

monthSel.onchange=load;
managerFilter.onchange=render;

/* ---------- LOAD DATA ---------- */
function load(){
  google.script.run.withSuccessHandler(res=>{
    ROLE=res.role;
    ALL_ROWS=res.rows || [];

    if(ROLE==="EDITOR"){
      valHead.classList.add("hidden");
      exportBtn.classList.add("hidden");
      totalBox.classList.add("hidden");
    }

    render();
  }).getData(monthSel.value);
}

/* ---------- RENDER TABLE ---------- */
function render(){
  tbody.innerHTML="";
  let rows=ALL_ROWS;

  const selectedManager=managerFilter.value;
  if(selectedManager){
    rows=rows.filter(r=>r.ProjectManager===selectedManager);
  }

  rows.forEach(r=>{
    tbody.innerHTML+=`
<tr>
<td>${r.Month||""}</td>
<td>${r.SlNo||""}</td>
<td>${r.Type}</td>
<td>${r.QuoteNo}</td>
<td>
  <textarea onblur="upd('${r.ID}','Project',this.value)">${r.Project||""}</textarea>
</td>
<td>
  <select onchange="upd('${r.ID}','ProjectManager',this.value)">
    <option></option>
    ${managers.map(m=>`<option ${m===r.ProjectManager?"selected":""}>${m}</option>`).join("")}
  </select>
</td>
<td>
  <input value="${r.Candidate||""}" onblur="upd('${r.ID}','Candidate',this.value)">
</td>
<td>
  <input type="date" value="${r.EnquiryReceived||""}"
         onchange="upd('${r.ID}','EnquiryReceived',this.value)">
</td>
<td>
  <input type="date" value="${r.Deadline||""}"
         onchange="upd('${r.ID}','Deadline',this.value)">
</td>
<td>
  <select onchange="upd('${r.ID}','Status',this.value)">
    <option ${r.Status==="Not Started"?"selected":""}>Not Started</option>
    <option ${r.Status==="Working"?"selected":""}>Working</option>
    <option ${r.Status==="Submitted"?"selected":""}>Submitted</option>
  </select>
</td>
<td class="${ROLE==="EDITOR"?"hidden":""}">
  <input type="number" value="${r.Value||""}"
         onblur="upd('${r.ID}','Value',this.value)">
</td>
<td>
  ${ROLE==="ADMIN" ? `<span class="del" onclick="delMain('${r.QuoteNo}')">✖</span>` : ""}
</td>
</tr>`;
  });

  updateTotal(rows);
}

/* ---------- TOTAL (FILTER AWARE) ---------- */
function updateTotal(rows){
  if(ROLE==="EDITOR") return;

  const total=rows.reduce(
    (sum,r)=>sum+(Number(r.Value)||0),
    0
  );

  totalBox.innerText=
    `Total Value for ${monthSel.value}: AED ${total.toLocaleString()}`;
}

/* ---------- ACTIONS ---------- */
function upd(id,field,val){
  google.script.run.updateCell(id,field,val);
}

function addMain(){
  google.script.run.addRow({
    Month:monthSel.value,
    Type:"Main",
    QuoteNo:"",
    Project:"",
    ProjectManager:"",
    Candidate:"",
    EnquiryReceived:"",
    Deadline:"",
    Status:"Not Started",
    Value:""
  });
  setTimeout(load,500);
}

function delMain(q){
  if(confirm("Delete this main quote and all related entries?")){
    google.script.run.deleteMainQuote(q);
    setTimeout(load,500);
  }
}

function exportExcel(){
  google.script.run.withSuccessHandler(url=>{
    window.open(url);
  }).exportExcel(monthSel.value);
}

/* ---------- INIT ---------- */
load();
</script>

</body>
</html>
