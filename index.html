<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Enquiry Log</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Calibri, Arial, sans-serif;
  background:#f4f6f8;
  padding:10px;
}

h2 { margin:0 0 6px 0; }
.header-ref { font-size:12px; font-weight:bold; margin-bottom:10px }

.topbar {
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:10px;
}

button {
  background:#0b2c5d;
  color:#fff;
  border:none;
  padding:6px 10px;
  cursor:pointer;
}

table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
  font-size:12px;
}

th, td {
  border:1px solid #d0d0d0;
  padding:4px 6px;
  text-align:center;
}

thead th {
  position:sticky;
  top:0;
  background:#e9eef5;
  z-index:5;
}

input, select {
  width:100%;
  height:22px;
  box-sizing:border-box;
  border:1px solid #bfbfbf;
  font-size:12px;
}

.sub { background:#fafafa }
.locked { background:#f0f0f0 }

.icon-btn {
  background:transparent;
  border:none;
  color:#0b2c5d;
  font-size:12px;
  font-weight:bold;
  cursor:pointer;
  padding:2px 4px;
}

.delete {
  color:#c0392b;
  cursor:pointer;
  font-size:11px;
}
</style>
</head>

<body>

<h2>Enquiry Log</h2>
<div class="header-ref">IRS-FORM-13-01</div>

<div class="topbar">
  <select id="monthSelect"></select>

  <select id="managerFilter">
    <option value="">All Managers</option>
  </select>

  <button type="button" id="addBtn">➕ Add Main Quote</button>
  <button type="button" id="excelBtn">⬇️ Download Excel</button>
</div>

<table>
<thead>
<tr>
<th>Month</th>
<th>Sl.No</th>
<th>Quote No</th>
<th>Type</th>
<th>Project</th>
<th>Manager</th>
<th>Candidate</th>
<th>Enquiry Received</th>
<th>Deadline</th>
<th>Status</th>
<th>Value</th>
<th>Action</th>
</tr>
</thead>
<tbody id="body"></tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
/* ================== CONFIG ================== */
const QUOTE_START = 8669;
const managers = ["Mr. Vishal","Mr. Mukesh","Mr. Irshad","Mr. Prem","Ms. Tania","Mr. Robbin"];
const candidates = ["Praneeth","Chetaka"];
const months = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];

/* ================== STATE ================== */
let currentMonth = months[new Date().getMonth()];
let rows = [];

/* ================== INIT ================== */
const body = document.getElementById("body");
const monthSelect = document.getElementById("monthSelect");
const managerFilter = document.getElementById("managerFilter");

months.forEach(m => monthSelect.add(new Option(m, m)));
monthSelect.value = currentMonth;

managers.forEach(m => managerFilter.add(new Option(m, m)));

monthSelect.onchange = () => {
  currentMonth = monthSelect.value;
  load();
};

managerFilter.onchange = render;

document.getElementById("addBtn").onclick = addMain;
document.getElementById("excelBtn").onclick = downloadExcel;

/* ================== STORAGE ================== */
function key() {
  return "ENQUIRY_LOG_" + currentMonth;
}

function load() {
  rows = JSON.parse(localStorage.getItem(key())) || [];
  render();
}

function save() {
  localStorage.setItem(key(), JSON.stringify(rows));
  render();
}

/* ================== LOGIC ================== */
function nextMainQuote() {
  let all = [];
  Object.keys(localStorage).forEach(k => {
    if (k.startsWith("ENQUIRY_LOG_")) {
      const data = JSON.parse(localStorage.getItem(k)) || [];
      data.forEach(r => { if (r.type === "Main") all.push(r.base); });
    }
  });
  return all.length ? Math.max(...all) + 1 : QUOTE_START;
}

function addMain() {
  const base = nextMainQuote();
  const sl = rows.filter(r => r.type === "Main").length + 1;

  rows.push({
    month: currentMonth,
    sl,
    base,
    quote: String(base),
    type: "Main",
    project: "",
    manager: "",
    candidate: "",
    received: "",
    deadline: "",
    status: "Not Started",
    value: ""
  });
  save();
}

function addSub(base, type) {
  const parent = rows.find(r => r.base === base && r.type === "Main");
  if (!parent) return;

  const count = rows.filter(r => r.base === base && r.type === type).length + 1;

  rows.push({
    month: "",
    sl: "",
    base,
    quote: base + "-" + (type === "Additional" ? "A" : "R") + count,
    type,
    project: "",
    manager: parent.manager,
    candidate: parent.candidate,
    received: "",
    deadline: "",
    status: "Not Started",
    value: ""
  });
  save();
}

function removeRow(i) {
  rows.splice(i, 1);
  save();
}

/* ================== RENDER ================== */
function render() {
  body.innerHTML = "";

  rows.forEach((r, i) => {
    if (managerFilter.value) {
      if (r.type === "Main" && r.manager !== managerFilter.value) return;
      if (r.type !== "Main") {
        const p = rows.find(x => x.base === r.base && x.type === "Main");
        if (!p || p.manager !== managerFilter.value) return;
      }
    }

    const locked = r.status === "Submitted";

    body.innerHTML += `
<tr class="${r.type !== "Main" ? "sub" : ""}">
<td>${r.month}</td>
<td>${r.sl}</td>
<td>${r.quote}</td>
<td>${r.type}</td>

<td><input ${locked?"disabled class=locked":""} value="${r.project}"
oninput="rows[${i}].project=this.value;save()"></td>

<td>
<select ${locked?"disabled":""}
onchange="rows[${i}].manager=this.value;save()">
<option></option>
${managers.map(m=>`<option ${m===r.manager?"selected":""}>${m}</option>`).join("")}
</select>
</td>

<td>
<select ${locked?"disabled":""}
onchange="rows[${i}].candidate=this.value;save()">
<option></option>
${candidates.map(c=>`<option ${c===r.candidate?"selected":""}>${c}</option>`).join("")}
</select>
</td>

<td><input type="date" ${locked?"disabled":""}
value="${r.received}"
onchange="rows[${i}].received=this.value;save()"></td>

<td><input type="date" ${locked?"disabled":""}
value="${r.deadline}"
onchange="rows[${i}].deadline=this.value;save()"></td>

<td>
<select onchange="rows[${i}].status=this.value;save()">
<option ${r.status==="Not Started"?"selected":""}>Not Started</option>
<option ${r.status==="Working"?"selected":""}>Working</option>
<option ${r.status==="Submitted"?"selected":""}>Submitted</option>
</select>
</td>

<td><input type="number" ${locked?"disabled class=locked":""}
value="${r.value}"
oninput="rows[${i}].value=this.value;save()"></td>

<td>
${r.type==="Main"
? `<button class="icon-btn" type="button" onclick="addSub(${r.base},'Additional')">➕A</button>
   <button class="icon-btn" type="button" onclick="addSub(${r.base},'Revision')">➕R</button>`
: `<span class="delete" onclick="removeRow(${i})">✖</span>`}
</td>
</tr>`;
  });
}

/* ================== EXCEL ================== */
function downloadExcel() {
  if (!rows.length) {
    alert("No data to export");
    return;
  }
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, currentMonth);
  XLSX.writeFile(wb, "Enquiry_" + currentMonth + ".xlsx");
}

/* ================== START ================== */
load();
</script>

</body>
</html>
