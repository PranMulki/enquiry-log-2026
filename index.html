<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enquiry Log 2026 - LIVE</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* Sticky frozen columns */
    th:nth-child(-n+4), td:nth-child(-n+4) { position: sticky; left: 0; background: inherit; z-index: 10; }
    th:nth-child(1) { left: 0 !important; }
    th:nth-child(2) { left: 80px !important; }
    th:nth-child(3) { left: 140px !important; }
    th:nth-child(4) { left: 200px !important; }
    thead th { position: sticky; top: 0; z-index: 20; }
  </style>
</head>
<body class="bg-gray-100 p-4 md:p-8 font-sans">
  <div id="app" class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-6 rounded-xl shadow-xl mb-8">
      <h1 class="text-4xl font-bold mb-2">üöÄ Enquiry / Estimation Log 2026</h1>
      <p class="opacity-90">LIVE DATA - Admin Dashboard | <strong>Apps Script URL:</strong> <code class="bg-white/20 px-2 py-1 rounded text-sm">{{ appsScriptUrl }}</code></p>
    </div>

    <!-- Controls -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
        <select v-model="filters.month" @change="fetchData" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="">üìÖ All Months</option>
          <option v-for="m in months" :key="m" :value="m">{{ m }}</option>
        </select>
        <input v-model="filters.manager" @input="debouncedFetch" placeholder="üë§ Project Manager" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
        <input v-model="filters.search" @input="debouncedFetch" placeholder="üîç Search Project/Quote/Name..." class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 lg:col-span-2">
      </div>
      
      <div class="flex flex-wrap gap-3 items-center">
        <button @click="showModal('Main')" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium flex items-center gap-2 shadow-md transition-all">
          ‚ûï Add Main Quote
        </button>
        <button @click="showModal('Additional')" class="bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-3 rounded-lg font-medium flex items-center gap-2 shadow-md transition-all">
          +A Additional
        </button>
        <button @click="showModal('Revision')" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-medium flex items-center gap-2 shadow-md transition-all">
          +R Revision
        </button>
        <select v-model="currency" @change="updateTotals" class="p-3 border border-gray-300 rounded-lg">
          <option>AED</option><option>USD</option><option>EUR</option>
        </select>
        <button @click="exportExcel" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-medium shadow-md transition-all">
          ‚¨á Export Excel (Filtered)
        </button>
      </div>
    </div>

    <!-- Totals Card -->
    <div class="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white p-6 rounded-xl shadow-xl mb-8 animate-pulse">
      <div class="flex justify-between items-center">
        <span class="text-xl font-semibold">üí∞ Total Value</span>
        <div>
          <span class="text-4xl font-black">{{ formatCurrency(totals) }}</span>
          <span class="ml-2 text-lg opacity-90">({{ currency }})</span>
        </div>
      </div>
      <div class="text-sm opacity-90 mt-1">Filtered view ‚Ä¢ {{ filteredData.length }} rows</div>
    </div>

    <!-- Data Table -->
    <div class="bg-white rounded-xl shadow-2xl overflow-hidden border border-gray-200">
      <div class="overflow-x-auto">
        <table class="w-full table-auto">
          <thead class="bg-gradient-to-r from-gray-100 to-gray-200">
            <tr>
              <th class="p-4 font-bold text-gray-800 border-r-2 border-gray-300">Month</th>
              <th class="p-4 font-bold text-gray-800 border-r-2 border-gray-300">Sl.No</th>
              <th class="p-4 font-bold text-gray-800 border-r-2 border-gray-300">Type</th>
              <th class="p-4 font-bold text-gray-800 border-r-2 border-gray-300">Quote No</th>
              <th class="p-4 font-bold text-gray-800 whitespace-nowrap">Project</th>
              <th class="p-4 font-bold text-gray-800 whitespace-nowrap">Manager</th>
              <th class="p-4 font-bold text-gray-800 whitespace-nowrap">Candidate</th>
              <th class="p-4 font-bold text-gray-800 whitespace-nowrap">Enquiry Date</th>
              <th class="p-4 font-bold text-gray-800 whitespace-nowrap">Deadline</th>
              <th class="p-4 font-bold text-gray-800 whitespace-nowrap">Status</th>
              <th class="p-4 font-bold text-gray-800 whitespace-nowrap text-right">Value AED</th>
              <th class="p-4 font-bold text-gray-800 whitespace-nowrap">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(row, idx) in filteredData" :key="idx" class="group hover:bg-blue-50 transition-all border-b border-gray-100">
              <td class="p-4 font-mono bg-white border-r-2 border-gray-300 group-hover:bg-blue-50">{{ row[0] }}</td>
              <td class="p-4 font-mono bg-white border-r-2 border-gray-300 group-hover:bg-blue-50">{{ row[1] }}</td>
              <td class="p-4 bg-white border-r-2 border-gray-300 group-hover:bg-blue-50">
                <span :class="getTypeBadge(row[2])">{{ row[2] }}</span>
              </td>
              <td class="p-4 font-mono bg-white border-r-2 border-gray-300 group-hover:bg-blue-50 font-semibold">{{ row[3] }}</td>
              <td class="p-4 max-w-md py-3" style="height:auto;max-height:80px;overflow:hidden;">
                <div class="whitespace-pre-wrap leading-relaxed">{{ row[4] }}</div>
              </td>
              <td class="p-4">{{ row[5] }}</td>
              <td class="p-4">{{ row[6] }}</td>
              <td class="p-4 font-mono">{{ row[7] }}</td>
              <td class="p-4 font-mono">{{ row[8] }}</td>
              <td class="p-4">
                <select v-model="row[9]" @change="quickUpdate(idx, row)" class="px-2 py-1 bg-gray-100 rounded text-sm">
                  <option>Pending</option>
                  <option>Approved</option>
                  <option>Rejected</option>
                  <option>In Progress</option>
                </select>
              </td>
              <td class="p-4 font-mono text-right font-semibold text-lg">{{ formatCurrency(row[10]) }}</td>
              <td class="p-4 space-x-2">
                <button @click="showModal('Edit', idx, row)" title="Edit" class="text-blue-500 hover:text-blue-700 p-2 rounded-full hover:bg-blue-100 transition-all">‚úèÔ∏è</button>
                <button @click="confirmDelete(idx)" title="Delete" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100 transition-all">‚ùå</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div v-if="!filteredData.length" class="p-12 text-center text-gray-500">
        <p class="text-xl mb-4">üì≠ No data matches filters</p>
        <button @click="resetFilters" class="bg-blue-500 text-white px-6 py-2 rounded-lg">Reset Filters</button>
      </div>
    </div>

    <!-- Modal -->
    <div v-if="showModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4" @click.self="showModal = false">
      <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <h3 class="text-2xl font-bold mb-6 flex items-center gap-3">
          {{ modalMode === 'Edit' ? '‚úèÔ∏è Edit' : `‚ûï ${modalType} Quote` }}
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <input v-model="modalData.project" placeholder="Project Description (multi-line OK)" class="p-4 border border-gray-300 rounded-xl w-full resize-vertical min-h-[100px]">
          <div>
            <input v-model="modalData.manager" placeholder="Project Manager" class="w-full p-3 border border-gray-300 rounded-lg mb-3">
            <input v-model="modalData.candidate" placeholder="Candidate" class="w-full p-3 border border-gray-300 rounded-lg mb-3">
          </div>
          <div>
            <label>Enquiry Date:</label>
            <input v-model="modalData.enquiryDate" type="date" class="w-full p-3 border border-gray-300 rounded-lg mt-1">
          </div>
          <div>
            <label>Deadline:</label>
            <input v-model="modalData.deadline" type="date" class="w-full p-3 border border-gray-300 rounded-lg mt-1">
          </div>
          <input v-model.number="modalData.value" type="number" placeholder="Value (AED)" class="p-3 border border-gray-300 rounded-lg md:col-span-2">
          <select v-model="modalData.status" class="p-3 border border-gray-300 rounded-lg md:col-span-2">
            <option>Pending</option><option>Approved</option><option>Rejected</option><option>In Progress</option>
          </select>
        </div>
        <div class="flex gap-3 pt-4">
          <button @click="saveModal" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white py-3 px-6 rounded-xl font-semibold shadow-lg transition-all">
            üíæ {{ modalMode === 'Edit' ? 'Update' : 'Create' }}
          </button>
          <button @click="showModal = false" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-6 rounded-xl font-semibold transition-all">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;
    createApp({
      data() {
        return {
          appsScriptUrl: 'https://script.google.com/macros/s/AKfycbyIFsWvmy4-h55hbEKP7XfpaFJANtVCVCNzGqfUF_qxq0pGwoOYuP8Aw0JE1439oZQq/exec',
          data: [],
          filteredData: [],
          filters: { month: '', manager: '', search: '' },
          months: [],
          currency: 'AED',
          totals: 0.00,
          showModal: false,
          modalMode: '',
          modalType: '',
          modalData: {},
          debounceTimer: null,
          loading: false
        };
      },
      mounted() {
        this.populateMonths();
        this.fetchData();
      },
      methods: {
        async fetchData() {
          this.loading = true;
          try {
            const params = new URLSearchParams(this.filters);
            const url = `${this.appsScriptUrl}?${params}`;
            const res = await fetch(url);
            const result = await res.json();
            this.data = result.data || [];
            this.filteredData = result.data || [];
            this.updateTotals();
          } catch (error) {
            console.error('API Error:', error);
            this.loadDemoData(); // Fallback
          }
          this.loading = false;
        },
        debouncedFetch() {
          clearTimeout(this.debounceTimer);
          this.debounceTimer = setTimeout(() => this.fetchData(), 400);
        },
        populateMonths() {
          this.months = [];
          for (let y = 2026; y <= 2036; y++) {
            ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'].forEach(m => {
              this.months.push(`${m} ${y}`);
            });
          }
        },
        showModal(type, editIdx = null, row = null) {
          this.modalType = type;
          this.modalMode = editIdx !== null ? 'Edit' : 'Add';
          if (row) {
            this.modalData = {
              project: row[4],
              manager: row[5],
              candidate: row[6],
              enquiryDate: row[7],
              deadline: row[8],
              status: row[9],
              value: row[10]
            };
          } else {
            this.modalData = {
              project: '', manager: '', candidate: '', enquiryDate: '', deadline: '',
              status: 'Pending', value: 0
            };
          }
          this.showModal = true;
        },
        async saveModal() {
          const payload = new URLSearchParams({
            action: this.modalMode === 'Edit' ? 'update' : 'add',
            type: this.modalType,
            project: this.modalData.project,
            manager: this.modalData.manager,
            candidate: this.modalData.candidate,
            enquiryDate: this.modalData.enquiryDate,
            deadline: this.modalData.deadline,
            status: this.modalData.status,
            value: this.modalData.value
          });
          
          try {
            const res = await fetch(this.appsScriptUrl, {
              method: 'POST',
              body: payload
            });
            if (res.ok) {
              this.fetchData();
              this.showModal = false;
              this.notify('‚úÖ Saved to Sheet1!');
            }
          } catch (e) {
            alert('Demo save - Update Code.gs for POST handling');
          }
        },
        async quickUpdate(idx, row) {
          // Inline status update
          await this.saveModal(); // Simplified
        },
        async confirmDelete(idx) {
          if (confirm('Delete this row from Sheet1?')) {
            const payload = new URLSearchParams({ action: 'delete', index: idx });
            await fetch(this.appsScriptUrl, { method: 'POST', body: payload });
            this.fetchData();
          }
        },
        async updateTotals() {
          const params = new URLSearchParams({ ...this.filters, currency: this.currency });
          const url = `${this.appsScriptUrl}?action=totals&${params}`;
          try {
            const res = await fetch(url);
            const data = await res.json();
            this.totals = parseFloat(data.total) || 0;
          } catch {
            this.totals = this.filteredData.reduce((sum, r) => sum + parseFloat(r[10] || 0), 0);
          }
        },
        formatCurrency(val) {
          return new Intl.NumberFormat('en-AE', {
            style: 'currency', currency: this.currency,
            minimumFractionDigits: 0
          }).format(val);
        },
        getTypeBadge(type) {
          const badges = {
            Main: 'bg-blue-100 text-blue-800 border-blue-300',
            Additional: 'bg-emerald-100 text-emerald-800 border-emerald-300',
            Revision: 'bg-orange-100 text-orange-800 border-orange-300'
          };
          return `px-3 py-1 rounded-full text-xs font-medium border inline-block ${badges[type] || 'bg-gray-100 text-gray-800'}`;
        },
        exportExcel() {
          const headers = ['Month', 'Sl.No', 'Type', 'Quote No', 'Project', 'Manager', 'Candidate', 'Enquiry Date', 'Deadline', 'Status', 'Value'];
          const exportData = this.filteredData.map(row => ({
            Month: row[0], 'Sl.No': row[1], Type: row[2], 'Quote No': row[3],
            Project: row[4], Manager: row[5], Candidate: row[6],
            'Enquiry Date': row[7], Deadline: row[8], Status: row[9], Value: row[10]
          }));
          
          const ws = XLSX.utils.json_to_sheet(exportData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, 'Enquiry Log');
          XLSX.writeFile(wb, `Enquiry_Log_${this.filters.month || 'All'}_${new Date().toISOString().slice(0,10)}.xlsx`);
        },
        resetFilters() {
          this.filters = { month: '', manager: '', search: '' };
          this.fetchData();
        },
        notify(msg) {
          // Simple toast
          const toast = document.createElement('div');
          toast.textContent = msg;
          toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-2xl z-50 animate-pulse';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 3000);
        },
        loadDemoData() {
          this.data = [
            ['JAN 2026', 1, 'Main', '8669', 'Sample Project Alpha\nMulti-line description\nWith details...', 'Praneeth', 'Candidate A', '01/01/26', '15/01/26', 'Pending', 50000],
            ['JAN 2026', 1, 'Additional', '8669-A1', 'Sample Project Alpha\nMulti-line description\nWith details...', 'Praneeth', 'Candidate A', '03/01/26', '18/01/26', 'Approved', 12000]
          ];
          this.filteredData = [...this.data];
          this.totals = 62000;
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
