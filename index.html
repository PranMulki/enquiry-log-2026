<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Enquiry Log</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:Calibri,Arial,sans-serif;
  background:#f4f6f8;
  padding:10px;
}
h2{margin:0 0 5px 0}
.header-ref{font-size:12px;font-weight:bold;margin-bottom:8px}

.topbar{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:10px;
}

button{
  background:#0b2c5d;
  color:#fff;
  border:none;
  padding:6px 10px;
  cursor:pointer;
  font-size:12px;
}

input,select,textarea{
  font-size:12px;
  height:22px;
  border:1px solid #bfbfbf;
  box-sizing:border-box;
}

textarea{
  width:100%;
  resize:none;
  padding:2px 4px;
}

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  font-size:12px;
}

th,td{
  border:1px solid #d0d0d0;
  padding:4px 6px;
  text-align:center;
}

thead th{
  position:sticky;
  top:0;
  background:#e9eef5;
  z-index:5;
}

.main-row{background:#fff}
.sub-row{background:#fafafa}

.indent{text-align:left;padding-left:20px}

.icon-btn{
  background:transparent;
  border:none;
  color:#0b2c5d;
  font-weight:bold;
  cursor:pointer;
  font-size:12px;
}

.delete{
  color:#c0392b;
  cursor:pointer;
  font-size:12px;
}

.locked{background:#f0f0f0}

.date{
  text-align:center;
}
</style>
</head>

<body>

<h2>Enquiry Log</h2>
<div class="header-ref">IRS-FORM-13-01</div>

<div class="topbar">
  <select id="monthSelect"></select>

  <select id="currencySelect">
    <option>AED</option>
    <option>USD</option>
    <option>EUR</option>
  </select>

  <select id="managerFilter">
    <option value="">All Managers</option>
  </select>

  <input id="searchBox" type="text" placeholder="Search anything…">

  <button type="button" id="addBtn">➕ Add Main Quote</button>
  <button type="button" id="excelBtn">⬇️ Download Excel</button>
</div>

<table>
<thead>
<tr>
<th>Month</th>
<th>Sl.No</th>
<th>Quote No</th>
<th>Type</th>
<th>Project</th>
<th>Manager</th>
<th>Candidate</th>
<th>Enquiry Received</th>
<th>Deadline</th>
<th>Status</th>
<th>Value</th>
<th>Action</th>
</tr>
</thead>
<tbody id="body"></tbody>
</table>

<div id="monthTotal" style="margin-top:8px;text-align:right;font-weight:bold"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
/* CONFIG */
const QUOTE_START=8669;
const managers=["Mr. Vishal","Mr. Mukesh","Mr. Irshad","Mr. Prem","Ms. Tania","Mr. Robbin"];
const candidates=["Praneeth","Chetaka"];
const months=["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];

/* STATE */
let currentMonth=months[new Date().getMonth()];
let rows=[];
let currency="AED";

/* ELEMENTS */
const body=document.getElementById("body");
const monthSelect=document.getElementById("monthSelect");
const managerFilter=document.getElementById("managerFilter");
const searchBox=document.getElementById("searchBox");
const currencySelect=document.getElementById("currencySelect");

/* INIT UI */
months.forEach(m=>monthSelect.add(new Option(m,m)));
monthSelect.value=currentMonth;
managers.forEach(m=>managerFilter.add(new Option(m,m)));

monthSelect.onchange=()=>{currentMonth=monthSelect.value;load()};
managerFilter.onchange=render;
searchBox.oninput=render;
currencySelect.onchange=()=>{
  currency=currencySelect.value;
  localStorage.setItem(currencyKey(),currency);
  render();
};

document.getElementById("addBtn").onclick=addMain;
document.getElementById("excelBtn").onclick=downloadExcel;

/* STORAGE */
const key=()=>`ENQUIRY_${currentMonth}`;
const currencyKey=()=>`ENQUIRY_CUR_${currentMonth}`;

function load(){
  rows=JSON.parse(localStorage.getItem(key()))||[];
  currency=localStorage.getItem(currencyKey())||"AED";
  currencySelect.value=currency;
  render();
}
function save(){
  localStorage.setItem(key(),JSON.stringify(rows));
  render();
}

/* DATE FORMAT */
function formatDate(v){
  if(!v) return "";
  const n=v.replace(/\D/g,"");
  if(n.length<6) return v;
  return `${n.slice(0,2)}/${n.slice(2,4)}/${n.slice(4,6)}`;
}

/* LOGIC */
function nextMainQuote(){
  let all=[];
  Object.keys(localStorage).forEach(k=>{
    if(k.startsWith("ENQUIRY_")&&!k.includes("CUR")){
      (JSON.parse(localStorage.getItem(k))||[])
        .filter(r=>r.type==="Main")
        .forEach(r=>all.push(r.base));
    }
  });
  return all.length?Math.max(...all)+1:QUOTE_START;
}

function addMain(){
  const base=nextMainQuote();
  const sl=rows.filter(r=>r.type==="Main").length+1;
  rows.push({
    month:currentMonth,sl,base,
    quote:String(base),type:"Main",
    project:"",manager:"",candidate:"",
    received:"",deadline:"",
    status:"Not Started",value:""
  });
  save();
}

function addSub(base,type){
  const p=rows.find(r=>r.base===base&&r.type==="Main");
  const n=rows.filter(r=>r.base===base&&r.type===type).length+1;
  rows.push({
    month:"",sl:"",base,
    quote:`${base}-${type==="Additional"?"A":"R"}${n}`,
    type,project:"",
    manager:p.manager,candidate:p.candidate,
    received:"",deadline:"",
    status:"Not Started",value:""
  });
  save();
}

function removeRow(i){
  rows.splice(i,1);
  save();
}

/* TOTAL */
function updateTotal(){
  const total=rows.reduce((s,r)=>{
    const v=parseFloat(r.value);
    return isNaN(v)?s:s+v;
  },0);
  document.getElementById("monthTotal").innerText=
    `Total Value for ${currentMonth} : ${currency} ${total.toLocaleString()}`;
}

/* RENDER */
function render(){
  body.innerHTML="";
  const q=searchBox.value.toLowerCase();

  rows.filter(r=>{
    if(managerFilter.value){
      const p=r.type==="Main"?r:rows.find(x=>x.base===r.base&&x.type==="Main");
      if(!p||p.manager!==managerFilter.value) return false;
    }
    return Object.values(r).join(" ").toLowerCase().includes(q);
  }).forEach((r,i)=>{
    const locked=r.status==="Submitted";
    body.innerHTML+=`
<tr class="${r.type==="Main"?"main-row":"sub-row"}">
<td>${r.month}</td>
<td>${r.sl}</td>
<td>${r.quote}</td>
<td class="${r.type!=="Main"?"indent":""}">${r.type!=="Main"?"↳ ":""}${r.type}</td>

<td>
<textarea rows="1" ${locked?"disabled class=locked":""}
onblur="rows[${i}].project=this.value;save()">${r.project}</textarea>
</td>

<td>
<select ${locked?"disabled":""}
onchange="rows[${i}].manager=this.value;save()">
<option></option>${managers.map(m=>`<option ${m===r.manager?"selected":""}>${m}</option>`).join("")}
</select>
</td>

<td>
<select ${locked?"disabled":""}
onchange="rows[${i}].candidate=this.value;save()">
<option></option>${candidates.map(c=>`<option ${c===r.candidate?"selected":""}>${c}</option>`).join("")}
</select>
</td>

<td>
<input class="date" placeholder="dd/mm/yy"
value="${r.received}"
onblur="rows[${i}].received=formatDate(this.value);save()">
</td>

<td>
<input class="date" placeholder="dd/mm/yy"
value="${r.deadline}"
onblur="rows[${i}].deadline=formatDate(this.value);save()">
</td>

<td>
<select onchange="rows[${i}].status=this.value;save()">
<option ${r.status==="Not Started"?"selected":""}>Not Started</option>
<option ${r.status==="Working"?"selected":""}>Working</option>
<option ${r.status==="Submitted"?"selected":""}>Submitted</option>
</select>
</td>

<td>
<input type="number" ${locked?"disabled class=locked":""}
value="${r.value}"
onblur="rows[${i}].value=this.value;save()">
</td>

<td>
${r.type==="Main"
?`<button class="icon-btn" onclick="addSub(${r.base},'Additional')">+A</button>
  <button class="icon-btn" onclick="addSub(${r.base},'Revision')">+R</button>`
:`<span class="delete" onclick="removeRow(${i})">✖</span>`}
</td>
</tr>`;
  });
  updateTotal();
}

/* EXCEL */
function downloadExcel(){
  if(!rows.length) return alert("No data");
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.json_to_sheet(rows.map(r=>({...r,Currency:currency})));
  XLSX.utils.book_append_sheet(wb,ws,currentMonth);
  XLSX.writeFile(wb,`Enquiry_${currentMonth}_${currency}.xlsx`);
}

/* START */
load();
</script>

</body>
</html>
